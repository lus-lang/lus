name: CI

on:
  push:
    branches: [main]
    paths:
      - "lus/**"
      - "lus-tests/**"
  pull_request:
    branches: [main]
    paths:
      - "lus/**"
      - "lus-tests/**"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Platform-specific tests run in parallel
  test:
    name: Test (${{ matrix.platform }})
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container || null }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux-glibc
            runner: ubuntu-latest
            suites: "--suite h1 --suite h2 --suite h3-ci --suite h4"
          - platform: linux-musl
            runner: ubuntu-latest
            container: alpine:latest
            suites: "--suite h1 --suite h2 --suite h4"
          - platform: macos-silicon
            runner: macos-14
            suites: "--suite h1 --suite h2 --suite h4"
          - platform: windows
            runner: windows-latest
            suites: "--suite h1 --suite h2 --suite h4"
    outputs:
      linux-glibc: ${{ steps.result.outputs.linux-glibc }}
      linux-musl: ${{ steps.result.outputs.linux-musl }}
      macos-silicon: ${{ steps.result.outputs.macos-silicon }}
      windows: ${{ steps.result.outputs.windows }}

    steps:
      - name: Install dependencies (Alpine)
        if: matrix.container == 'alpine:latest'
        run: apk add --no-cache build-base meson openssl-dev c-ares-dev git

      - name: Install dependencies (Ubuntu)
        if: matrix.runner == 'ubuntu-latest' && matrix.container == null
        run: |
          sudo apt-get update
          sudo apt-get install -y meson llvm libssl-dev libc-ares-dev

      - name: Install dependencies (macOS)
        if: matrix.runner == 'macos-14'
        run: brew install meson readline openssl c-ares

      - name: Install dependencies (Windows)
        if: matrix.runner == 'windows-latest'
        run: |
          pip install meson ninja
          vcpkg install c-ares:x64-windows
          echo "CMAKE_PREFIX_PATH=C:\vcpkg\installed\x64-windows" >> $env:GITHUB_ENV
        env:
          VCPKG_DEFAULT_TRIPLET: x64-windows

      - name: Setup MSVC (Windows)
        if: matrix.runner == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build (debug)
        run: |
          cd lus
          meson setup build --buildtype=debug
          meson compile -C build lus:executable

      - name: Test
        run: meson test -C lus/build -v --print-errorlogs ${{ matrix.suites }}

      - name: Print test log on failure
        if: failure()
        run: cat lus/build/meson-logs/testlog.txt

      - name: Set result output
        id: result
        if: always()
        run: echo "${{ matrix.platform }}=${{ job.status }}" >> $GITHUB_OUTPUT

  # Sanitizer build for memory safety validation
  sanitize:
    name: Sanitizers
    needs: [test]
    if: always() && !cancelled()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y meson llvm libssl-dev libc-ares-dev

      - name: Build with sanitizers
        run: |
          cd lus
          meson setup build --buildtype=debug -Db_sanitize=address,undefined -Db_lundef=false
          meson compile -C build lus:executable

      - name: Test
        env:
          ASAN_OPTIONS: detect_leaks=0:print_stacktrace=1:symbolize=1
          UBSAN_OPTIONS: print_stacktrace=1:symbolize=1
        run: meson test -C lus/build -v --print-errorlogs --maxfail=1 --suite h1 --suite h2 --suite h3-ci --suite h4

      - name: Print test log on failure
        if: failure()
        run: cat lus/build/meson-logs/testlog.txt

  # Platform-specific release builds (only for platforms that passed tests)
  build:
    name: Build (${{ matrix.platform }})
    needs: [test]
    if: always() && !cancelled()
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container || null }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux-glibc
            runner: ubuntu-latest
            artifact: lus-linux
            artifact_path: lus/build/lus
          - platform: linux-musl
            runner: ubuntu-latest
            container: alpine:latest
            artifact: lus-linux-musl
            artifact_path: lus/build/lus
          - platform: macos-silicon
            runner: macos-14
            artifact: lus-macos
            artifact_path: lus/build/lus
          - platform: windows
            runner: windows-latest
            artifact: lus-windows
            artifact_path: lus/build/lus.exe

    steps:
      - name: Install bash (Alpine)
        if: matrix.container == 'alpine:latest'
        run: apk add --no-cache bash

      - name: Check if test passed
        id: check
        shell: bash
        run: |
          result="${{ needs.test.outputs[matrix.platform] }}"
          if [[ "$result" == "success" ]]; then
            echo "proceed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Test for ${{ matrix.platform }} passed, proceeding with build"
          else
            echo "proceed=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Skipping build - test for ${{ matrix.platform }} did not pass (status: $result)"
          fi

      - name: Install dependencies (Alpine)
        if: steps.check.outputs.proceed == 'true' && matrix.container == 'alpine:latest'
        run: apk add --no-cache build-base meson openssl-dev c-ares-dev git

      - name: Install dependencies (Ubuntu)
        if: steps.check.outputs.proceed == 'true' && matrix.runner == 'ubuntu-latest' && matrix.container == null
        run: |
          sudo apt-get update
          sudo apt-get install -y meson libssl-dev libc-ares-dev

      - name: Install dependencies (macOS)
        if: steps.check.outputs.proceed == 'true' && matrix.runner == 'macos-14'
        run: brew install meson readline openssl c-ares

      - name: Install dependencies (Windows)
        if: steps.check.outputs.proceed == 'true' && matrix.runner == 'windows-latest'
        run: |
          pip install meson ninja
          vcpkg install c-ares:x64-windows
          echo "CMAKE_PREFIX_PATH=C:\vcpkg\installed\x64-windows" >> $env:GITHUB_ENV
        env:
          VCPKG_DEFAULT_TRIPLET: x64-windows

      - name: Setup MSVC (Windows)
        if: steps.check.outputs.proceed == 'true' && matrix.runner == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Checkout
        if: steps.check.outputs.proceed == 'true'
        uses: actions/checkout@v4

      - name: Build (release)
        if: steps.check.outputs.proceed == 'true'
        run: |
          cd lus
          meson setup build --buildtype=release
          meson compile -C build lus:executable

      - name: Upload artifact
        if: steps.check.outputs.proceed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact_path }}

  # WASM build (separate - no test dependency)
  build-wasm:
    name: Build (wasm)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.64

      - name: Build WASM
        run: |
          cd lus/wasm
          ./build.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: lus-wasm
          path: lus/wasm/dist/

  # Test result summary
  summary:
    name: Summary
    needs: [test, sanitize, build, build-wasm]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate summary
        run: |
          echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Test results
          for platform in linux-glibc linux-musl macos-silicon windows; do
            result="${{ needs.test.outputs[env.platform] }}"
            case "$platform" in
              linux-glibc) result="${{ needs.test.outputs.linux-glibc }}" ;;
              linux-musl) result="${{ needs.test.outputs.linux-musl }}" ;;
              macos-silicon) result="${{ needs.test.outputs.macos-silicon }}" ;;
              windows) result="${{ needs.test.outputs.windows }}" ;;
            esac
            if [[ "$result" == "success" ]]; then
              echo "| $platform | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
            elif [[ "$result" == "failure" ]]; then
              echo "| $platform | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $platform | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üî¨ Sanitizers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.sanitize.result }}" == "success" ]]; then
            echo "‚úÖ Memory safety checks passed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.sanitize.result }}" == "failure" ]]; then
            echo "‚ùå Memory safety issues detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚è≠Ô∏è Sanitizer checks skipped" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üì¶ Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "‚úÖ Release builds completed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build.result }}" == "failure" ]]; then
            echo "‚ö†Ô∏è Some release builds failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚è≠Ô∏è Release builds skipped" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.build-wasm.result }}" == "success" ]]; then
            echo "‚úÖ WASM build completed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build-wasm.result }}" == "failure" ]]; then
            echo "‚ùå WASM build failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚è≠Ô∏è WASM build skipped" >> $GITHUB_STEP_SUMMARY
          fi

  # Create pre-release with available artifacts
  release:
    name: Create Pre-release
    needs: [build, build-wasm]
    runs-on: ubuntu-latest
    if: always() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/main' && !cancelled()
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Delete previous unstable releases
        run: |
          # Get all releases starting with 'unstable-'
          releases=$(gh release list --json tagName --jq '.[] | select(.tagName | startswith("unstable-")) | .tagName' || true)

          for tag in $releases; do
            echo "Deleting old unstable release: $tag"
            gh release delete "$tag" --yes --cleanup-tag || true
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download available artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Prepare release assets
        id: prepare
        run: |
          mkdir -p release
          count=0

          # Linux (glibc)
          if [ -f artifacts/lus-linux/lus ]; then
            cp artifacts/lus-linux/lus release/lus-linux
            echo "‚úÖ linux-glibc artifact included"
            count=$((count + 1))
          else
            echo "‚è≠Ô∏è linux-glibc artifact not available"
          fi

          # Linux (musl)
          if [ -f artifacts/lus-linux-musl/lus ]; then
            cp artifacts/lus-linux-musl/lus release/lus-linux-musl
            echo "‚úÖ linux-musl artifact included"
            count=$((count + 1))
          else
            echo "‚è≠Ô∏è linux-musl artifact not available"
          fi

          # macOS
          if [ -f artifacts/lus-macos/lus ]; then
            cp artifacts/lus-macos/lus release/lus-macos
            echo "‚úÖ macos artifact included"
            count=$((count + 1))
          else
            echo "‚è≠Ô∏è macos artifact not available"
          fi

          # Windows
          if [ -f artifacts/lus-windows/lus.exe ]; then
            cp artifacts/lus-windows/lus.exe release/lus-windows.exe
            echo "‚úÖ windows artifact included"
            count=$((count + 1))
          else
            echo "‚è≠Ô∏è windows artifact not available"
          fi

          # WASM
          if [ -f artifacts/lus-wasm/lus.js ]; then
            cp artifacts/lus-wasm/lus.js release/lus.js
            cp artifacts/lus-wasm/lus.wasm release/lus.wasm
            echo "‚úÖ wasm artifacts included"
            count=$((count + 1))
          else
            echo "‚è≠Ô∏è wasm artifacts not available"
          fi

          echo "artifact_count=$count" >> $GITHUB_OUTPUT

          if [ $count -eq 0 ]; then
            echo "‚ùå No artifacts available for release"
            exit 1
          fi

          echo ""
          echo "üì¶ Release contents ($count platforms):"
          ls -la release/

      - name: Create unstable release
        run: |
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"

          artifact_count="${{ steps.prepare.outputs.artifact_count }}"

          gh release create "unstable-${SHORT_SHA}" \
            --title "Unstable (${SHORT_SHA})" \
            --notes "Automated build from commit ${{ github.sha }}

          **Included platforms:** ${artifact_count}/5 available

          > ‚ö†Ô∏è This is an unstable pre-release build. Use at your own risk." \
            --prerelease \
            release/*
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
