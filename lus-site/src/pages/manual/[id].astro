---
import ManualLayout from "../../components/ManualLayout.astro"
import { getCollection, getEntry, render } from "astro:content"

export async function getStaticPaths() {
  const manual = await getCollection("manual")
  return manual.map((page) => ({
    params: { id: page.id },
    props: { page },
  }))
}

const manual = await getCollection("manual")
const page = await getEntry("manual", Astro.params.id!)!
const rendered = await render(page)

// Find the next acquis if this page is an acquis
const acquis = manual
  .filter((p) => p.data.acquis)
  .toSorted((a, b) => a.data.order - b.data.order)
const currentIndex = page.data.acquis
  ? acquis.findIndex((p) => p.id === page.id)
  : -1
const nextAcquis =
  currentIndex >= 0 && currentIndex < acquis.length - 1
    ? acquis[currentIndex + 1]
    : null
---

<ManualLayout title={page.data.title} unstable={page.data.draft}>
  <h1>{page.data.title}</h1>
  {
    rendered.headings.length > 0 && (
      <div class="toc">
        {rendered.headings
          .filter((heading) => heading.depth <= 2)
          .map((heading, i) => (
            <>
              {i > 0 ? "· " : ""}
              <a href={`#${heading.slug}`}>{heading.text}</a>
            </>
          ))}
      </div>
    )
  }
  {
    page.data.draft && (
      <div class="draft-notice">
        This manual page contains unstable information and its contents may
        change at any time.
      </div>
    )
  }
  <rendered.Content />
  {
    nextAcquis && (
      <nav class="next-acquis">
        <a href={`/manual/${nextAcquis.id}`}>{nextAcquis.data.title} →</a>
      </nav>
    )
  }
</ManualLayout>

<style>
  @reference "../../styles/global.css";

  .draft-notice {
    @apply bg-red-100 border border-red-300 text-red-800 px-4 py-2 mb-4 text-sm;
  }

  .toc {
    @apply text-lime-700 mb-4;
    a {
      @apply font-normal no-underline hover:bg-lime-200 lowercase;
    }
  }

  .next-acquis {
    @apply font-mono;
    a {
      @apply text-lime-700 hover:text-lime-900 no-underline hover:bg-lime-200;
    }
  }

  :global(html.unstable) {
    .toc {
      @apply text-red-700;
      a {
        @apply hover:bg-red-200;
      }
    }

    .next-acquis a {
      @apply text-red-700 hover:text-red-900 hover:bg-red-200;
    }
  }
</style>
