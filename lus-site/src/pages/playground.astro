---
import PlaygroundLayout from "../components/PlaygroundLayout.astro"
---

<PlaygroundLayout>
  <button slot="controls" id="run-btn" class="btn-run" disabled>Run</button>
  <button slot="controls" id="clear-btn" class="btn-clear">Clear</button>

  <Fragment slot="version">
    <select id="version-select" class="version-select" disabled>
      <option value="">Loading...</option>
    </select>
    <span id="version-tag"></span>
  </Fragment>

  <div class="pane editor-pane">
    <div class="pane-header">Code</div>
    <div id="code-editor"></div>
  </div>
  <div class="pane output-pane">
    <div class="pane-header">Output</div>
    <div class="output-content" id="output"></div>
  </div>
</PlaygroundLayout>

<script>
  import { init } from "modern-monaco"
  import { registerSyntax } from "modern-monaco/core"
  //@ts-ignore
  import { grammars } from "modern-monaco/shiki"
  import { getWasmReleases, loadLusWasm } from "../lib/wasm-loader"
  import type { WasmRelease, LusModule } from "../lib/wasm-loader"
  import lusGrammar from "../../../lus-textmate/lus.tmLanguage.json"

  // HACK: this sucks but it works
  grammars.push(lusGrammar as any)
  registerSyntax(lusGrammar as any)

  const editorContainer = document.getElementById("code-editor")!
  const output = document.getElementById("output")!
  const runBtn = document.getElementById("run-btn") as HTMLButtonElement
  const clearBtn = document.getElementById("clear-btn") as HTMLButtonElement
  const versionSelect = document.getElementById(
    "version-select"
  ) as HTMLSelectElement
  const versionTag = document.getElementById("version-tag")!

  let currentModule: LusModule | null = null
  let releases: { stable: WasmRelease | null; unstable: WasmRelease | null }
  let editor: ReturnType<typeof monaco.editor.create>
  let monaco: Awaited<ReturnType<typeof init>>

  function appendOutput(
    text: string,
    type: "output" | "error" | "system" = "output"
  ) {
    const lines = text.split("\n")
    for (const lineText of lines) {
      if (lineText === "" && type === "output") continue
      const line = document.createElement("div")
      line.className = `output-line ${type}`
      line.textContent = lineText
      output.appendChild(line)
    }
    output.scrollTop = output.scrollHeight
  }

  function clearOutput() {
    output.innerHTML = ""
  }

  async function loadVersion(release: WasmRelease) {
    runBtn.disabled = true
    clearOutput()
    appendOutput("Loading...", "system")

    try {
      if (currentModule) {
        currentModule.destroy()
        currentModule = null
      }

      currentModule = await loadLusWasm(release)
      clearOutput()
      runBtn.disabled = false
      versionTag.textContent = release.isStable ? "stable" : "unstable"
      versionTag.className = release.isStable ? "tag stable" : "tag unstable"
    } catch (e) {
      appendOutput(`Failed to load: ${e}`, "error")
    }
  }

  function runCode() {
    if (!currentModule || !editor) return

    const code = editor.getValue()
    if (!code.trim()) return

    try {
      const result = currentModule.execute(code)
      if (result && result.trim()) {
        appendOutput(result.trimEnd(), "output")
      } else {
        appendOutput("(no output)", "system")
      }
    } catch (e) {
      appendOutput(String(e), "error")
    }
  }

  async function initEditor() {
    monaco = await init({
      defaultTheme: "dark-plus",
    })

    editor = monaco.editor.create(editorContainer, {
      language: "lus",
      automaticLayout: true,
      minimap: { enabled: false },
      fontSize: 14,
      fontFamily: "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace",
      lineNumbers: "on",
      scrollBeyondLastLine: false,
      wordWrap: "on",
      tabSize: 2,
      padding: { top: 16, bottom: 16 },
    })

    const model = monaco.editor.createModel(`print("Hello, Lus!")`, "lus")
    editor.setModel(model)

    editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runCode)
  }

  async function initWasm() {
    try {
      if (typeof SharedArrayBuffer === "undefined") {
        appendOutput("SharedArrayBuffer not available. This is probably because you're running this site locally. This is a funny bug on both Firefox and Chromium:\nhttps://bugzilla.mozilla.org/show_bug.cgi?id=1984864\nhttps://issues.chromium.org/issues/386633375\n(let me know when this is fixed so I can remove this message)", "error")
        return
      }

      releases = await getWasmReleases()

      versionSelect.innerHTML = ""

      if (releases.stable) {
        const opt = document.createElement("option")
        opt.value = "stable"
        opt.textContent = `${releases.stable.version} (stable)`
        versionSelect.appendChild(opt)
      }

      if (releases.unstable) {
        const opt = document.createElement("option")
        opt.value = "unstable"
        opt.textContent = `${releases.unstable.version} (unstable)`
        versionSelect.appendChild(opt)
      }

      if (!releases.stable && !releases.unstable) {
        appendOutput("No WASM builds available.", "error")
        return
      }

      versionSelect.disabled = false

      const defaultRelease = releases.stable || releases.unstable
      if (defaultRelease) {
        await loadVersion(defaultRelease)
      }
    } catch (e) {
      appendOutput(`Failed to fetch releases: ${e}`, "error")
    }
  }

  runBtn.addEventListener("click", runCode)
  clearBtn.addEventListener("click", clearOutput)

  versionSelect.addEventListener("change", async () => {
    const selected = versionSelect.value
    const release = selected === "stable" ? releases.stable : releases.unstable
    if (release) {
      await loadVersion(release)
    }
  })

  // Initialize both editor and WASM
  await Promise.all([initEditor(), initWasm()])
</script>

<style>
  @reference "../styles/global.css";

  .btn-run {
    @apply px-4 py-1.5 font-bold text-sm cursor-pointer bg-lime-500 text-lime-950 hover:bg-lime-400;

    &:disabled {
      @apply opacity-50 cursor-not-allowed hover:bg-lime-500;
    }
  }

  .btn-clear {
    @apply px-4 py-1.5 font-bold text-sm cursor-pointer bg-lime-800 text-lime-200 hover:bg-lime-700;
  }

  .version-select {
    @apply bg-lime-800 text-lime-200 border border-lime-600 px-2 py-1.5 text-sm cursor-pointer;

    &:disabled {
      @apply opacity-50 cursor-not-allowed;
    }
  }

  .tag {
    @apply px-2 py-0.5 text-xs font-bold uppercase;

    &:global(.stable) {
      @apply bg-lime-600 text-lime-950;
    }

    &:global(.unstable) {
      @apply bg-red-600 text-red-100;
    }
  }

  .pane {
    @apply flex-1 flex flex-col min-h-0 min-w-0;
  }

  .pane-header {
    @apply px-4 py-2 bg-lime-900 text-lime-400 text-sm font-bold uppercase tracking-wide border-b border-lime-700 shrink-0;
  }

  .editor-pane {
    @apply border-r border-lime-700;
  }

  #code-editor {
    @apply flex-1 w-full;
  }

  .output-content {
    @apply flex-1 overflow-y-auto p-4 font-mono text-sm;
  }

  :global(.output-line) {
    @apply whitespace-pre-wrap break-all text-lime-100;

    &:global(.system) {
      @apply text-lime-400 italic;
    }

    &:global(.error) {
      @apply text-red-400;
    }
  }
</style>

