global print, require, assert, type, os, io, string, arg, tostring, package

local function find_container_engine()
    local engines = {"podman", "docker"}
    for i = 1, #engines do
        local eng = engines[i]
        if os.execute(eng .. " --version > /dev/null 2>&1") then
            return eng
        end
    end
    return nil
end

local engine = find_container_engine()
if not engine then
    print("\27[31mError: No container engine (podman/docker) found.\27[0m")
    print("H3 tests require a container runtime.")
    os.exit(1)
end

print("Using container engine: " .. engine)

-- Current directory should be the project root (where 'lus' executable is built)
local cwd = os.getenv("PWD") or "."

-- Check if we're on a platform where the built binary can run in a Linux container
local is_linux = package.config:sub(1,1) == "/" and os.getenv("OSTYPE") ~= "darwin"

-- Try to detect if we're actually on Linux by checking /proc
local f = io.open("/proc/version", "r")
if f then
    f:close()
    is_linux = true
else
    is_linux = false
end

if not is_linux then
    print("\27[33mWarning: Not on Linux - built binary may not run in Linux container.\27[0m")
    print("Skipping containerized tests. Use --suite h3-ci on a native Linux host.")
    os.exit(0)
end

-- Path to the built binary (relative to project root)
local lus_bin = "/src/lus/build/lus"

-- Helper to run test in container
local function run_test_in_container(test_file)
    print("Running H3 test: " .. test_file)

    -- Build command to run the test inside an Ubuntu container
    -- Mount the project directory to /src and run the lus binary with the test file
    local cmd = string.format(
        "%s run --rm -v %s:/src -w /src ubuntu:latest %s /src/%s",
        engine, cwd, lus_bin, test_file
    )

    local status = os.execute(cmd)
    if not status then
        print("\27[31mFailed: " .. test_file .. "\27[0m")
        os.exit(1)
    end
end

-- Run the H3 tests
run_test_in_container("lus-tests/h3/test_io.lus")
run_test_in_container("lus-tests/h3/files.lus")
run_test_in_container("lus-tests/h3/cli.lus")
run_test_in_container("lus-tests/h3/fs.lus")


print("\27[32mH3: All system tests passed (Containerized).\27[0m")
os.exit(0)
