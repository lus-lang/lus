--[[
  pledge.lus - Tests for the permission system (Acquis 11)
  Tests the pledge() function and permission enforcement.
]]

global print, tostring, type, string, table, io, os, fs, network, pledge, dofile, error, assert

-- Grant fs and load permissions first (needed for dofile/loadfile/require in tests)
pledge("fs")
pledge("load")

-- Load test framework
local framework = dofile("../framework.lus")
local tests = framework.new("pledge")

-- Helper function to check equality
local function expect_eq(got, expected, msg)
  if got ~= expected then
    error((msg or "Assertion failed") .. ": expected " .. tostring(expected) .. ", got " .. tostring(got))
  end
end

-- Helper function to check not nil
local function expect_not_nil(val, msg)
  if val == nil then
    error((msg or "Value") .. " was nil")
  end
end

-- ============================================
-- Basic pledge functionality
-- ============================================
tests:describe("basic pledge functionality")

tests:it("pledge returns true when granting permission", function()
  -- exec is a valid permission registered in lbaselib.c
  local result = pledge("exec")
  expect_eq(result, true, "pledge should return true")
end)

tests:it("pledge returns true for already granted permission", function()
  -- exec already granted above
  local result = pledge("exec")
  expect_eq(result, true, "duplicate pledge should return true")
end)

tests:it("unknown permission errors", function()
  local ok, err = catch pledge("nonexistent_permission")
  expect_eq(ok, false, "unknown permission should error")
end)

-- ============================================  
-- Permission rejection with ~ prefix
-- ============================================
tests:describe("permission rejection")

tests:it("~permission marks as rejected", function()
  -- Use a permission we won't need later (network:udp in this case)
  local result = pledge("~network:udp")
  expect_eq(result, true, "rejecting permission should return true")
end)

tests:it("rejected permission cannot be granted", function()
  -- network:udp was rejected above
  local ok, err = catch pledge("network:udp")
  expect_eq(ok, false, "granting rejected permission should fail")
end)

-- ============================================
-- fs permissions
-- ============================================
tests:describe("filesystem permissions")

tests:it("fs.list works with fs permission", function()
  pledge("fs")  
  local result = fs.list("/tmp")
  expect_eq(type(result), "table", "fs.list should return table")
end)

tests:it("fs:read permission with exact path works", function()
  pledge("fs:read=/var")
  -- Permission granted, just verify pledge works
  local granted = pledge("fs:read=/var")
  expect_eq(granted, true, "pledge should grant path permission")
end)

-- ============================================
-- exec permissions  
-- ============================================
tests:describe("exec permissions")

tests:it("exec permission can be granted", function()
  local result = pledge("exec")
  expect_eq(result, true, "exec pledge should succeed")
end)

tests:it("os.execute works with exec permission", function()
  pledge("exec")
  local ok = os.execute("true")
  -- On success, os.execute returns true (or exit code)
  expect_not_nil(ok, "os.execute should return something")
end)

-- ============================================
-- network permissions
-- ============================================
tests:describe("network permissions")

tests:it("network permission can be granted", function()
  local result = pledge("network")
  expect_eq(result, true, "network pledge should succeed")
end)

tests:it("network:http permission can be granted", function()
  local result = pledge("network:http")
  expect_eq(result, true, "network:http pledge should succeed")
end)

tests:it("network:tcp permission can be granted", function()
  local result = pledge("network:tcp")
  expect_eq(result, true, "network:tcp pledge should succeed")
end)

-- ============================================
-- Permission values (path/URL restrictions)
-- ============================================
tests:describe("permission values")

tests:it("permission with value can be granted", function()
  local result = pledge("fs:read=/specific/path")
  expect_eq(result, true, "pledge with value should succeed")
end)

tests:it("multiple values can be granted", function()
  pledge("fs:read=/path1")
  pledge("fs:read=/path2")
  -- Both should succeed (accumulative)
  local r1 = pledge("fs:read=/path1")
  local r2 = pledge("fs:read=/path2")
  expect_eq(r1, true, "first path should be granted")
  expect_eq(r2, true, "second path should be granted")
end)

-- ============================================
-- Evasion checks (security tests)
-- ============================================
tests:describe("evasion checks")

tests:it("path traversal blocked (../)", function()
  -- Grant only /tmp/* access
  pledge("fs:read=/tmp/*")
  -- Try to escape via ../
  local ok = catch fs.list("/tmp/../etc")
  expect_eq(ok, false, "path traversal should be blocked")
end)

tests:it("absolute path required", function()
  -- fs:read for /tmp/* shouldn't allow relative paths
  pledge("fs:read=/tmp/*")
  local ok = catch fs.list("tmp")
  expect_eq(ok, false, "relative paths should be blocked")
end)

tests:it("double dot in filename blocked", function()
  -- Grant /var/* but try /var/..
  pledge("fs:read=/var/*")
  local ok = catch fs.list("/var/..")
  expect_eq(ok, false, "parent directory escape should be blocked")
end)

tests:it("permission escalation blocked", function()
  -- After sealing, can't grant broader permissions
  -- We'll test this with the all permission
  local ok = catch pledge("all")
  expect_eq(ok, false, "granting 'all' from script should fail")
end)

tests:it("unknown subpermission errors", function()
  -- Try to grant a made-up subpermission - should error
  local ok, err = catch pledge("fs:execute")
  expect_eq(ok, false, "unknown subpermission should error")
end)

tests:it("empty permission name errors", function()
  local ok = catch pledge("")
  expect_eq(ok, false, "empty permission should error")
end)

-- ============================================
-- seal permission
-- ============================================
tests:describe("seal permission")

tests:it("seal permission can be granted", function()
  -- Note: We can't test seal in same process since it's irreversible
  local result = pledge("seal")
  expect_eq(result, true, "seal pledge should succeed")
end)

tests:it("after seal, new permissions return false", function()
  pledge("seal")
  -- After seal, even valid permissions return false
  -- Use network:http since network:tcp was rejected earlier in tests
  local result = pledge("network:http")
  expect_eq(result, false, "after seal, new permissions should fail")
end)

-- Finish
tests:finish()
