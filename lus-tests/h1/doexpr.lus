--[[
    Do Expressions Test Suite
    Tests for do expressions feature (acquis-23)
]]

global print, require, assert, type, pledge, tostring, select

pledge("load", "fs:read=./lus-tests/*", "seal")

local framework = require("lus-tests.framework")
local tests = framework.new("do_expressions")

-- =============================================================================
-- Basic Usage Tests
-- =============================================================================

tests:it("basic do expression with provide", function()
    local x = do
        provide 42
    end
    assert(x == 42, "x should be 42, got " .. tostring(x))
end)

tests:it("do expression with local variable", function()
    local x = do
        local y = 10
        provide y
    end
    assert(x == 10, "x should be 10, got " .. tostring(x))
end)

tests:it("do expression without provide returns nil", function()
    local x = do
        local y = 10
    end
    assert(x == nil, "x should be nil, got " .. tostring(x))
end)

tests:it("empty provide returns nil", function()
    local x = do
        provide
    end
    assert(x == nil, "x should be nil, got " .. tostring(x))
end)

tests:it("do expression in arithmetic", function()
    local w = 5 + do provide 10 end
    assert(w == 15, "5 + do provide 10 end should be 15, got " .. tostring(w))
end)

tests:it("do expression in string concat", function()
    local s = "hello " .. do provide "world" end
    assert(s == "hello world", "string concat failed, got " .. tostring(s))
end)

-- =============================================================================
-- Nesting Tests
-- =============================================================================

tests:it("nested do expressions (2 levels)", function()
    local nested = do
        provide do provide 42 end
    end
    assert(nested == 42, "nested should be 42, got " .. tostring(nested))
end)

tests:it("nested do expressions (3 levels)", function()
    local deep = do
        local a = do
            local b = do
                provide 100
            end
            provide b + 1
        end
        provide a + 1
    end
    assert(deep == 102, "deep should be 102, got " .. tostring(deep))
end)

tests:it("nested do with local variables", function()
    local result = do
        local outer = 10
        local inner_result = do
            local inner = 5
            provide outer + inner
        end
        provide inner_result * 2
    end
    assert(result == 30, "result should be 30, got " .. tostring(result))
end)

-- =============================================================================
-- Multiple Values Tests
-- =============================================================================

tests:it("provide multiple values", function()
    local x, y = do
        provide 10, 20
    end
    assert(x == 10, "x should be 10, got " .. tostring(x))
    assert(y == 20, "y should be 20, got " .. tostring(y))
end)

tests:it("provide three values", function()
    local a, b, c = do
        provide 1, 2, 3
    end
    assert(a == 1, "a should be 1, got " .. tostring(a))
    assert(b == 2, "b should be 2, got " .. tostring(b))
    assert(c == 3, "c should be 3, got " .. tostring(c))
end)

tests:it("provide fewer values than expected", function()
    local x, y, z = do
        provide 10
    end
    assert(x == 10, "x should be 10, got " .. tostring(x))
    assert(y == nil, "y should be nil, got " .. tostring(y))
    assert(z == nil, "z should be nil, got " .. tostring(z))
end)

tests:it("discard extra values", function()
    local x = do
        provide 10, 20, 30
    end
    assert(x == 10, "x should be 10, got " .. tostring(x))
end)

-- =============================================================================
-- Control Flow Tests
-- =============================================================================

tests:it("provide in conditional (if branch)", function()
    local cond = do
        local n = 10
        if n > 5 then
            provide "big"
        else
            provide "small"
        end
    end
    assert(cond == "big", "cond should be 'big', got " .. tostring(cond))
end)

tests:it("provide in conditional (else branch)", function()
    local cond = do
        local n = 3
        if n > 5 then
            provide "big"
        else
            provide "small"
        end
    end
    assert(cond == "small", "cond should be 'small', got " .. tostring(cond))
end)

tests:it("provide terminates block", function()
    local x = do
        provide 42
        -- anything after provide is unreachable
    end
    assert(x == 42, "x should be 42, got " .. tostring(x))
end)

tests:it("early provide in loop", function()
    local result = do
        local i = 0
        while true do
            i = i + 1
            if i == 5 then
                provide i
            end
        end
    end
    assert(result == 5, "result should be 5, got " .. tostring(result))
end)

-- =============================================================================
-- Scope Tests
-- =============================================================================

tests:it("access outer variables", function()
    local outer = 50
    local result = do
        local inner = 5
        provide outer + inner
    end
    assert(result == 55, "result should be 55, got " .. tostring(result))
end)

tests:it("inner variables don't leak", function()
    local y
    local x = do
        local inner_var = 123
        provide inner_var
    end
    -- inner_var is not accessible here (would be compile error)
    assert(x == 123, "x should be 123, got " .. tostring(x))
end)

tests:it("shadowing outer variable", function()
    local x = 100
    local result = do
        local x = 200  -- shadows outer x
        provide x
    end
    assert(result == 200, "result should be 200, got " .. tostring(result))
    assert(x == 100, "outer x should still be 100, got " .. tostring(x))
end)

-- =============================================================================
-- Edge Cases
-- =============================================================================

tests:it("do expression as function argument", function()
    local function add(a, b)
        return a + b
    end
    local result = add(do provide 10 end, do provide 20 end)
    assert(result == 30, "result should be 30, got " .. tostring(result))
end)

tests:it("do expression in table constructor", function()
    local t = {
        a = do provide 1 end,
        b = do provide 2 end
    }
    assert(t.a == 1, "t.a should be 1, got " .. tostring(t.a))
    assert(t.b == 2, "t.b should be 2, got " .. tostring(t.b))
end)

tests:it("chained do expressions", function()
    local x = do provide 10 end + do provide 20 end + do provide 30 end
    assert(x == 60, "chained sum should be 60, got " .. tostring(x))
end)

tests:it("do expression with function definition", function()
    local fn = do
        local function inner()
            return 42
        end
        provide inner
    end
    assert(type(fn) == "function", "fn should be a function")
    assert(fn() == 42, "fn() should return 42, got " .. tostring(fn()))
end)

tests:it("do expression modifying upvalue", function()
    local counter = 0
    local increment = do
        local function inc()
            counter = counter + 1
            return counter
        end
        provide inc
    end
    assert(increment() == 1, "first call should return 1")
    assert(increment() == 2, "second call should return 2")
    assert(counter == 2, "counter should be 2")
end)

-- =============================================================================
-- Integration with catch
-- =============================================================================

tests:it("catch with do expression (success)", function()
    local ok, val = catch do
        provide 10
    end
    assert(ok == true, "ok should be true, got " .. tostring(ok))
    assert(val == 10, "val should be 10, got " .. tostring(val))
end)

tests:it("do expression inside catch", function()
    local ok, result = catch do
        local x = do
            provide 42
        end
        provide x * 2
    end
    assert(ok == true, "ok should be true")
    assert(result == 84, "result should be 84, got " .. tostring(result))
end)

-- =============================================================================
-- Finish
-- =============================================================================

tests:finish()
