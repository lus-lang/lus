global print, require, assert, type, load, string, table, error, _G, tostring, pledge

pledge("load", "fs:read=./lus-tests/*", "seal")

local framework = require("lus-tests.framework")
local tests = framework.new("goto")

tests:it("simple goto", function()
    local x = 0
    local function f()
        local y = 12
        goto l1
        ::l2:: x = x + 1; goto l3
        ::l1:: x = y; goto l2
        ::l3::
    end
    f()
    assert(x == 13)
end)

tests:it("goto error handling (scoping)", function()
    local function checkerr(code, msg)
        -- catch load(code) returns (status, result, error_if_any)
        -- If load throws: status=false, result=thrown_error
        -- If load returns normally: status=true, result=load_result, error_if_any=load_error
        local ok, f, err = catch load(code)
        if not ok then
             -- load raised error directly (status=false means throw)
             assert(string.find(f, msg), "Load raise '"..f.."' missing '"..msg.."'")
             return
        end
        
        -- load didn't throw, check if it returned nil + error
        if f == nil then
             -- load returned (nil, error_message), which catch wraps as (true, nil, error_message)
             -- So 'err' contains the actual error message
             assert(err ~= nil, "Expected error message from load")
             assert(string.find(err, msg), "Load error '"..tostring(err).."' missing '"..msg.."'")
             return
        end
        
        -- load succeeded with a function, run it and expect runtime error
        local run_ok, run_err = catch f()
        assert(not run_ok, "Expected runtime error for: "..code)
        assert(string.find(run_err, msg), "Error '"..run_err.."' missing '"..msg.."'")
    end

    -- cannot see label inside block
    checkerr([[ goto l1; do ::l1:: end ]], "label 'l1'")
    
    -- jump into block
    checkerr([[ do ::l1:: end goto l1 ]], "label 'l1'")
end)

tests:it("global declarations", function()
    -- Lus specific global tests
    local f = assert(load([[
        global g_var = 10
        return g_var
    ]]))
    assert(f() == 10)
    assert(_G.g_var == 10)
end)

tests:finish()
